{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport { RNSharedElementContent } from \"./RNSharedElementContent.web\";\nimport { RNSharedElementStyle } from \"./RNSharedElementStyle.web\";\nimport { Rect } from \"./Rect.web\";\nexport var RNSharedElementNode = function () {\n  function RNSharedElementNode(domNode, isParent, ancestorDomNode) {\n    _classCallCheck(this, RNSharedElementNode);\n\n    this.hideRefCount = 0;\n    this.hideOpacity = null;\n    this.refCount = 1;\n    this.styleCache = null;\n    this.styleCallbacks = null;\n    this.contentCache = null;\n    this.contentCallbacks = null;\n    this.domNode = domNode;\n    this.isParent = isParent;\n    this.ancestorDomNode = ancestorDomNode;\n  }\n\n  _createClass(RNSharedElementNode, [{\n    key: \"addRef\",\n    value: function addRef() {\n      return ++this.refCount;\n    }\n  }, {\n    key: \"releaseRef\",\n    value: function releaseRef() {\n      return --this.refCount;\n    }\n  }, {\n    key: \"addHideRef\",\n    value: function addHideRef() {\n      this.hideRefCount++;\n\n      if (this.hideRefCount === 1) {\n        var element = this.resolvedElement;\n        this.hideOpacity = element.style.opacity;\n        element.style.opacity = \"0\";\n      }\n    }\n  }, {\n    key: \"releaseHideRef\",\n    value: function releaseHideRef() {\n      this.hideRefCount--;\n\n      if (this.hideRefCount === 0) {\n        var element = this.resolvedElement;\n        element.style.opacity = this.hideOpacity;\n      }\n    }\n  }, {\n    key: \"resolvedElement\",\n    get: function get() {\n      var element = this.domNode;\n\n      if (this.isParent) {\n        if (element.childNodes.length === 1) {\n          element = element.childNodes[0];\n        } else if (element.childNodes.length <= 0) {\n          console.log(\"Child for parent doesnt exist\");\n          return null;\n        }\n      }\n\n      var _element = element,\n          childNodes = _element.childNodes;\n\n      if (childNodes.length === 2) {\n        for (var i = 0; i < 2; i++) {\n          var childNode = childNodes[i];\n\n          if (childNode.tagName === \"IMG\") {\n            element = childNodes[i ? 0 : i + 1];\n            break;\n          }\n        }\n      }\n\n      return element;\n    }\n  }, {\n    key: \"resolvedAncestor\",\n    get: function get() {\n      return this.ancestorDomNode;\n    }\n  }, {\n    key: \"requestStyle\",\n    value: function requestStyle() {\n      var _this = this;\n\n      if (this.styleCache) {\n        return Promise.resolve(this.styleCache);\n      }\n\n      return new Promise(function (resolve) {\n        _this.styleCallbacks = _this.styleCallbacks || [];\n\n        _this.styleCallbacks.push(resolve);\n\n        if (!_this.fetchInitialStyle()) {\n          console.debug(\"Failed to fetch style\");\n        }\n      });\n    }\n  }, {\n    key: \"fetchInitialStyle\",\n    value: function fetchInitialStyle() {\n      var element = this.resolvedElement;\n      var ancestor = this.resolvedAncestor;\n      if (!element || !ancestor) return false;\n      if (!this.styleCallbacks) return true;\n      var rect = element.getBoundingClientRect();\n      var ancestorRect = ancestor.getBoundingClientRect();\n      var translateX = ancestorRect.x;\n      var translateY = ancestorRect.y;\n      var layout = new Rect({\n        x: rect.x - translateX,\n        y: rect.y - translateY,\n        width: rect.width,\n        height: rect.height\n      });\n      var style = new RNSharedElementStyle(layout, window.getComputedStyle(element, null));\n      this.styleCache = style;\n      var callbacks = this.styleCallbacks;\n      this.styleCallbacks = null;\n      callbacks.forEach(function (callback) {\n        return callback(style);\n      });\n      return true;\n    }\n  }, {\n    key: \"requestContent\",\n    value: function requestContent() {\n      var _this2 = this;\n\n      return _regeneratorRuntime.async(function requestContent$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!this.contentCache) {\n                _context.next = 2;\n                break;\n              }\n\n              return _context.abrupt(\"return\", this.contentCache);\n\n            case 2:\n              return _context.abrupt(\"return\", new Promise(function (resolve) {\n                if (_this2.contentCallbacks) return;\n                _this2.contentCallbacks = _this2.contentCallbacks || [];\n\n                _this2.contentCallbacks.push(resolve);\n\n                _this2.fetchInitialContent();\n              }));\n\n            case 3:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, this, null, Promise);\n    }\n  }, {\n    key: \"fetchInitialContent\",\n    value: function fetchInitialContent() {\n      var element, size, content, callbacks;\n      return _regeneratorRuntime.async(function fetchInitialContent$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              element = this.resolvedElement;\n\n              if (element) {\n                _context2.next = 3;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", false);\n\n            case 3:\n              if (this.contentCallbacks) {\n                _context2.next = 5;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", true);\n\n            case 5:\n              _context2.next = 7;\n              return _regeneratorRuntime.awrap(RNSharedElementContent.getSize(element));\n\n            case 7:\n              size = _context2.sent;\n\n              if (size) {\n                _context2.next = 10;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", false);\n\n            case 10:\n              content = new RNSharedElementContent(element, size);\n              this.contentCache = content;\n              callbacks = this.contentCallbacks;\n              this.contentCallbacks = null;\n              callbacks.forEach(function (callback) {\n                return callback(content);\n              });\n              return _context2.abrupt(\"return\", true);\n\n            case 16:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, null, this, null, Promise);\n    }\n  }]);\n\n  return RNSharedElementNode;\n}();","map":{"version":3,"sources":["../../src/web/RNSharedElementNode.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { RNSharedElementContent } from \"./RNSharedElementContent.web\";\nimport { RNSharedElementStyle } from \"./RNSharedElementStyle.web\";\nimport { Rect } from \"./Rect.web\";\nimport { IHTMLElement } from \"./types\";\n\nexport type RNSharedElementNodeStyleCallback = (\n  value: RNSharedElementStyle\n) => void;\nexport type RNSharedElementNodeContentCallback = (\n  value: RNSharedElementContent\n) => void;\n\nexport class RNSharedElementNode {\n  public readonly domNode: IHTMLElement;\n  public readonly ancestorDomNode: IHTMLElement;\n  public readonly isParent: boolean;\n  private hideRefCount: number = 0;\n  private hideOpacity: string | null = null;\n  private refCount: number = 1;\n  private styleCache: RNSharedElementStyle | null = null;\n  private styleCallbacks: RNSharedElementNodeStyleCallback[] | null = null;\n  private contentCache: RNSharedElementContent | null = null;\n  private contentCallbacks: RNSharedElementNodeContentCallback[] | null = null;\n\n  constructor(\n    domNode: IHTMLElement,\n    isParent: boolean,\n    ancestorDomNode: IHTMLElement\n  ) {\n    this.domNode = domNode;\n    this.isParent = isParent;\n    this.ancestorDomNode = ancestorDomNode;\n  }\n\n  addRef() {\n    return ++this.refCount;\n  }\n\n  releaseRef() {\n    return --this.refCount;\n  }\n\n  addHideRef() {\n    this.hideRefCount++;\n    if (this.hideRefCount === 1) {\n      const element = this.resolvedElement;\n      this.hideOpacity = element!.style.opacity;\n      element!.style.opacity = \"0\";\n    }\n  }\n\n  releaseHideRef() {\n    this.hideRefCount--;\n    if (this.hideRefCount === 0) {\n      const element = this.resolvedElement;\n      // @ts-ignore\n      element!.style.opacity = this.hideOpacity;\n    }\n  }\n\n  get resolvedElement(): IHTMLElement | null {\n    let element: IHTMLElement = this.domNode;\n\n    // If this node is a parent, look for the first child\n    if (this.isParent) {\n      if (element.childNodes.length === 1) {\n        // @ts-ignore\n        element = element.childNodes[0];\n      } else if (element.childNodes.length <= 0) {\n        console.log(\"Child for parent doesnt exist\");\n        return null;\n      }\n    }\n\n    // Get background-image node\n    const { childNodes } = element;\n    if (childNodes.length === 2) {\n      for (let i = 0; i < 2; i++) {\n        // @ts-ignore\n        const childNode: IHTMLElement = childNodes[i];\n        if (childNode.tagName === \"IMG\") {\n          // @ts-ignore\n          element = childNodes[i ? 0 : i + 1];\n          break;\n        }\n      }\n    }\n\n    return element;\n  }\n\n  get resolvedAncestor(): IHTMLElement | null {\n    return this.ancestorDomNode;\n  }\n\n  requestStyle(): Promise<RNSharedElementStyle> {\n    if (this.styleCache) {\n      return Promise.resolve(this.styleCache);\n    }\n    return new Promise((resolve) => {\n      this.styleCallbacks = this.styleCallbacks || [];\n      this.styleCallbacks.push(resolve);\n      if (!this.fetchInitialStyle()) {\n        console.debug(\"Failed to fetch style\");\n        //startRetryLoop();\n      }\n    });\n  }\n\n  private fetchInitialStyle(): boolean {\n    const element = this.resolvedElement;\n    const ancestor = this.resolvedAncestor;\n    if (!element || !ancestor) return false;\n    if (!this.styleCallbacks) return true;\n\n    // Fetch layout\n    const rect = element.getBoundingClientRect();\n    // const ancestorTransform = ancestor.style.transform;\n    const ancestorRect = ancestor.getBoundingClientRect();\n    // console.log(\"ancestorTransform: \", ancestor.style, ancestorRect);\n    const translateX = ancestorRect.x; // TODO\n    const translateY = ancestorRect.y; // TODO\n    const layout = new Rect({\n      x: rect.x - translateX,\n      y: rect.y - translateY,\n      width: rect.width,\n      height: rect.height,\n    });\n\n    // Create style\n    const style = new RNSharedElementStyle(\n      layout,\n      // @ts-ignore\n      window.getComputedStyle(element, null)\n    );\n\n    // console.debug(\"Style fetched: \", style);\n\n    // Update cache\n    this.styleCache = style;\n\n    // Notify callbacks\n    const callbacks = this.styleCallbacks;\n    this.styleCallbacks = null;\n    callbacks.forEach((callback) => callback(style));\n    return true;\n  }\n\n  async requestContent(): Promise<RNSharedElementContent> {\n    if (this.contentCache) return this.contentCache;\n\n    return new Promise((resolve) => {\n      if (this.contentCallbacks) return;\n      this.contentCallbacks = this.contentCallbacks || [];\n      this.contentCallbacks.push(resolve);\n      this.fetchInitialContent();\n      // TODO RETRY IN CASE OF FAILURE?\n    });\n  }\n\n  private async fetchInitialContent(): Promise<boolean> {\n    const element = this.resolvedElement;\n    if (!element) return false;\n    if (!this.contentCallbacks) return true;\n\n    // Fetch content size\n    const size = await RNSharedElementContent.getSize(element);\n    if (!size) {\n      return false;\n    }\n\n    // Create content\n    const content = new RNSharedElementContent(element, size);\n\n    // console.debug(\"Content fetched: \", content);\n\n    // Update cache\n    this.contentCache = content;\n\n    // Notify callbacks\n    const callbacks = this.contentCallbacks;\n    this.contentCallbacks = null;\n    callbacks.forEach((callback) => callback(content));\n    return true;\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}